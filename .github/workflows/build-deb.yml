name: Build Fouldecrypt

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: macos-latest

    env:
      THEOS: ${{ github.workspace }}/theos
      SDKROOT: /Applications/Xcode_16.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX15.0.sdk
      CC: clang
      CXX: clang++

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        brew install make ldid dpkg
        # Add GNU make to PATH
        export PATH="/opt/homebrew/opt/make/libexec/gnubin:$PATH"
        # Clone Theos
        git clone --depth=1 https://github.com/theos/theos.git $THEOS

    - name: Build fouldecrypt
      run: |
        rm -f packages/*
        cp control.template control
        PROVIDER="TFP0"

        if [[ "$PROVIDER" == "TFP0" ]]; then
          USE_TFP0=1 make -j$(sysctl -n hw.ncpu) package FINALPACKAGE=1
        elif [[ "$PROVIDER" == "LIBKRW" ]]; then
          sed -i '' 's/{{.depends}}/libkrw/g' control
          USE_LIBKRW=1 make -j$(sysctl -n hw.ncpu) package FINALPACKAGE=1
        elif [[ "$PROVIDER" == "LIBKERNRW" ]]; then
          sed -i '' 's/{{.depends}}/libkernrw0/g' control
          USE_LIBKERNRW=1 make -j$(sysctl -n hw.ncpu) package FINALPACKAGE=1
        fi
      shell: bash
